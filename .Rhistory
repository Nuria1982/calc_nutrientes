left_join(boro_seleccionada, by = "Lote")
return(tabla_general)
})
output$tabla_total <- renderUI({
data <- resultados_total()
if (is.null(data)) {
return(tags$div(
style = "color: red; font-weight: bold;",
"Por favor ingrese los datos en Carga de datos"
))
}
tabla_html <- paste0(
"<table style='width: 100%; border-collapse: collapse;'>",
"<thead><tr>",
"<th style='background-color: #CCCCCC; padding: 5px;'>Lote</th>",
"<th style='background-color: #CCCCCC; padding: 5px;'>Cultivo</th>",
"<th style='background-color: #CCCCCC; padding: 5px;'>Rendimiento<br>(tn / ha)</th>",
"<th style='background-color: #C5223360; padding: 5px;'>Dosis de nitrogeno<br>(kg N / ha)</th>",
"<th style='background-color: #58815760; padding: 5px;'>Dosis de suficiencia<br>(kg P / ha)</th>",
"<th style='background-color: #BC6C2560; padding: 5px;'>Dosis de construccion y mantenimiento<br>(kg P / ha)</th>",
"<th style='background-color: #DEB84160; padding: 5px;'>Dosis de azufre <br>(kg S / ha)</th>",
"<th style='background-color: #168AAD60; padding: 5px;'>Extracción de zinc <br>(g Zn / ha)</th>",
"<th style='background-color: #778DA960; padding: 5px;'>Extracción de boro <br>(g B / ha)</th>",
"</tr></thead>",
"<tbody>",
paste(
apply(data, 1, function(row) {
paste0(
"<tr>",
paste0("<td style='padding: 10px;'>", row, "</td>", collapse = ""),
"</tr>"
)
}),
collapse = ""
),
"</tbody></table>"
)
HTML(tabla_html)
})
output$descarga_total <- downloadHandler(
filename = function() {
paste("resultados_total_", Sys.Date(), ".xlsx", sep = "")
},
content = function(file) {
library(openxlsx)
wb <- createWorkbook()
addWorksheet(wb, "resultados_total")
# Escribir los resultados en la hoja
writeData(wb, "resultados_total", resultados_total(), startRow = 1, startCol = 1)
aclaracion_1 <- "*Los valores de N disponible, Oferta y Dosis no fueron calculados debido a la falta de datos de nitratos (0-20, 20-40, o 40-60)."
# Calcular la fila donde se escribirá el mensaje (después de los datos)
start_row <- nrow(resultados_total()) + 2
# Escribir las aclaraciones dejando una fila de espacio
writeData(wb, "resultados_total", aclaracion_1, startRow = start_row + 1, startCol = 1)
# Guardar el archivo Excel
saveWorkbook(wb, file, overwrite = TRUE)
}
)
################## MONITOREO NITRÓGENO #####################################
#### Lote único
indice_suf_nitrogeno <- reactive({
req(input$índice_monitoreo, input$IFR_monitoreo)
input$índice_monitoreo / input$IFR_monitoreo
})
output$indice_suf_nitrogeno <- renderUI({
req(indice_suf_nitrogeno())  # Asegúrate de que indice_suf_nitrogeno() tenga un valor válido
div(
class = "value-box",
style = "display: flex; flex-direction: column; align-items: center; justify-content: center; background-color: #A3B18A; color: white; border-radius: 10px; height: 160px; width: 300px; padding: 10px;",
div(
style = "font-size: 20px; font-weight: bold; margin-bottom: 6px; text-align: center;",
HTML("<strong>Índice de suficiencia de nitrógeno:</strong>")
),
div(
style = "display: flex; justify-content: space-between; width: 60%; align-items: center;",
div(
style = "font-size: 30px; font-weight: bold;",
round(indice_suf_nitrogeno(), 2)
),
div(
class = "icon-container",
style = "font-size: 40px;",
icon("hourglass-3")
)
)
)
})
dosis_monitoreo <- reactive({
req(input$cultivo_monitoreo, indice_suf_nitrogeno())
dosis <- if (input$cultivo_monitoreo == "maiz") {
324 - 329 * (indice_suf_nitrogeno()^3.12)
} else if (input$cultivo_monitoreo == "trigo") {
509 - 657 * (indice_suf_nitrogeno()^3.52)
} else if (input$cultivo_monitoreo == "papa") {
336 - 346 * (indice_suf_nitrogeno()^3.36)
} else {
NA
}
# Asegurar que la dosis no sea negativa
max(0, dosis)
})
output$dosis_monitoreo <- renderUI({
req(dosis_monitoreo())  # Asegúrate de que dosis_monitoreo() tenga un valor válido
div(
class = "value-box",
style = "display: flex; flex-direction: column; align-items: center; justify-content: center; background-color: #588157; color: white; border-radius: 10px; height: 160px; width: 300px; padding: 10px;",
div(
style = "font-size: 20px; font-weight: bold; margin-bottom: 6px; text-align: center;",
HTML("<strong>Dosis óptima económica<br>(kg N / ha):</strong>")
),
div(
style = "display: flex; justify-content: space-between; width: 60%; align-items: center;",
div(
style = "font-size: 30px; font-weight: bold;",
round(dosis_monitoreo(), 0)  # Llamada correcta a la función reactiva
),
div(
class = "icon-container",
style = "font-size: 40px;",
icon("droplet")
)
)
)
})
output$grafico_monitoreo <- renderPlot({
req(input$cultivo_monitoreo)  # Asegúrate de que el usuario seleccionó un cultivo
# Define el rango de ISN
ISN <- seq(0.5, 1, by = 0.01)
# Calcula la dosis de nitrógeno según el cultivo
dosis <- if (input$cultivo_monitoreo == "maiz") {
324 - 329 * (ISN^3.12)
} else if (input$cultivo_monitoreo == "trigo") {
509 - 657 * (ISN^3.52)
} else if (input$cultivo_monitoreo == "papa") {
336 - 346 * (ISN^3.36)
} else {
rep(NA, length(ISN))  # Si no hay cultivo, devuelve NA
}
# Crear un data frame para el gráfico
datos <- data.frame(ISN = ISN, Dosis = dosis)
ISN_usuario <- indice_suf_nitrogeno()
Dosis_usuario <- dosis_monitoreo()
titulo <- if (input$cultivo_monitoreo == "maiz") {
"Relación entre ISN y DOE para maíz en V10"
} else if (input$cultivo_monitoreo == "trigo") {
"Relación entre ISN y DOE para trigo en Z31, un nudo"
} else if (input$cultivo_monitoreo == "papa") {
"Relación entre ISN y DOE para papa en llenado de tubérculos"
} else {
paste("Relación entre ISN y DOE en", input$cultivo_monitoreo)
}
ggplot(datos, aes(x = ISN, y = Dosis)) +
geom_point(color = "#4C72B0", size = 3, alpha = 0.6) +
geom_line(color = "#DD8452", size = 1.0) +
geom_point(aes(x = ISN_usuario, y = Dosis_usuario),
color = "#F28E2C", size = 6, shape = 21,
stroke = 1.5) +
geom_segment(aes(x = ISN_usuario, xend = ISN_usuario,
y = 0, yend = Dosis_usuario),
linetype = "dashed", color = "#F28E2C", size = 0.8, alpha = 0.6) +
geom_segment(aes(x = 0.5, xend = ISN_usuario,
y = Dosis_usuario, yend = Dosis_usuario),
linetype = "dashed", color = "#F28E2C", size = 0.8, alpha = 0.6) +
scale_x_continuous(limits = c(0.5, 1), breaks = seq(0.5, 1, by = 0.05)) +
scale_y_continuous(limits = c(0, 300),
labels = scales::comma,
breaks = seq(0, 300, by = 50)) +
labs(
title = titulo,
x = "Índice de Suficiencia de Nitrógeno (ISN)",
y = "Dosis óptima económica (DOE, kg N / ha)"
) +
theme_minimal(base_size = 12) +
theme(
plot.title = element_text(
face = "bold", size = 18, hjust = 0.5, color = "#333333"
),
axis.title = element_text(face = "bold", size = 16, color = "#555555"),
axis.text = element_text(face = "bold", size = 14, color = "#333333"),
panel.grid.major = element_line(color = "#D9D9D9"),
panel.grid.minor = element_blank()
)
})
#### Múltiples lotes
output$tabla_monitoreo <- downloadHandler(
filename = function() {
"data_monitoreo.xlsx"
},
content = function(file) {
# Crear un dataframe modelo
datos <- data.frame(
Lote = c(1, 2),
Cultivo = c("maiz", "trigo"),
Estadio = c(NA, NA),
Indice_vegetacion = c(NA, NA),
Indice_franja_referencia = c(NA, NA)
)
# Renombrar las columnas con las unidades correspondientes
column_units <- c(
Lote = "Lote",
Cultivo = "Cultivo",
Estadio = "Estadio",
Indice_vegetacion = "Índice de vegetación",
Indice_franja_referencia = "Índice de franja de referencia"
)
# Aplicar los nuevos nombres al data.frame
colnames(datos) <- column_units[colnames(datos)]
library(openxlsx)
wb <- createWorkbook()
addWorksheet(wb, "Datos")
writeData(wb, "Datos", datos)
estilo_general1 <- createStyle(fgFill = "gray90",
textDecoration = "bold",
border = "Bottom",
borderColour = "black",
borderStyle = "thin",
wrapText = TRUE )
addStyle(wb, "Datos", style = estilo_general1, rows = 1, cols = c(1:5), gridExpand = TRUE)
saveWorkbook(wb, file, overwrite = TRUE)
}
)
data_monitoreo <- reactive({
if (is.null(input$archivo_monitoreo)) {
return(NULL)
}
ext <- tools::file_ext(input$archivo_monitoreo$name)
if (ext == "csv") {
data <- read.csv(input$archivo_monitoreo$datapath)
} else if (ext == "xlsx") {
data <- readxl::read_xlsx(input$archivo_monitoreo$datapath, sheet = "Datos")
} else {
showNotification("Formato de archivo no soportado.", type = "error")
return(NULL)
}
# Verificar si el archivo tiene las columnas requeridas
required_columns <- c("Lote", "Cultivo", "Estadio", "Índice de vegetación", "Índice de franja de referencia")
missing_columns <- setdiff(required_columns, colnames(data))
if (length(missing_columns) > 0) {
showNotification(
paste("El archivo no tiene las columnas requeridas:",
paste(missing_columns, collapse = ", ")),
type = "error"
)
return(NULL)
}
# Renombrar las columnas con las unidades correspondientes
column_original <- c(
Lote = "Lote",
Cultivo = "Cultivo",
`Estadio` = "Estadio" ,
`Índice de vegetación` = "Indice_vegetación",
`Índice de franja de referencia` = "Indice_franja_referencia"
)
# Aplicar los nuevos nombres al data.frame
colnames(data) <- column_original[colnames(data)]
colnames(data) <- tolower(colnames(data))
data$cultivo <- tolower(data$cultivo)
data$estadio <- tolower(data$estadio)
# Confirmar al usuario que el archivo se ha procesado correctamente
showNotification("Archivo subido correctamente.", type = "message")
return(data)
})
resultados_monitoreo <- reactive({
req(data_monitoreo())
datos <- data_monitoreo()
datos <- datos %>%
mutate(
indice_suf_nitrogeno = round(`indice_vegetación` / `indice_franja_referencia`, 2)
) %>%
mutate(
dosis_monitoreo = case_when(
cultivo == "maiz" ~ round(324 - 329 * (indice_suf_nitrogeno^3.12), 0),
cultivo == "trigo" ~ round(509 - 657 * (indice_suf_nitrogeno^3.52), 0),
cultivo == "papa" ~ round(336 - 346 * (indice_suf_nitrogeno^3.36), 0),
TRUE ~ NA_real_ # Manejar casos donde el cultivo no coincide
)
)
datos_resultado <- datos %>%
select(
lote, cultivo, indice_suf_nitrogeno, dosis_monitoreo
) %>%
rename(`Lote` = lote,
`Cultivo` = cultivo,
`Índice de suficiencia de nitrógeno` = indice_suf_nitrogeno,
`Dosis óptima económica (kg N / ha)` = dosis_monitoreo
)
return(datos_resultado)
})
output$tabla_monitoreoN <- renderUI({
data <- resultados_monitoreo()
tabla_html <- paste0(
"<table style='width: 100%; border-collapse: collapse;'>",
"<thead><tr>",
"<th style='background-color: #CCCCCC; padding: 5px;'>Lote</th>",
"<th style='background-color: #CCCCCC; padding: 5px;'>Cultivo</th>",
"<th style='background-color: #A3B18A60; padding: 5px;'>Índice de suficiencia de nitrógeno</th>",
"<th style='background-color: #58815760; padding: 5px;'>Dosis óptima económica <br>(kg N / ha)</th>",
"</tr></thead>",
"<tbody>",
paste(
apply(data, 1, function(row) {
paste0(
"<tr>",
paste0("<td style='padding: 10px;'>", row, "</td>", collapse = ""),
"</tr>"
)
}),
collapse = ""
),
"</tbody></table>"
)
HTML(tabla_html)
})
output$descarga_monitoreoN <- downloadHandler(
filename = function() {
paste("monitoreoN_", Sys.Date(), ".xlsx", sep = "")
},
content = function(file) {
write_xlsx(resultados_monitoreo(), file)
}
)
}
runApp()
runApp()
runApp()
excel_url <- "https://intaarg-my.sharepoint.com/:x:/g/personal/lewczuk_nuria_inta_gob_ar/EciVc8sF6BRHi6szY_uENk8BlSjNuxRN8Ikt4tVUpjRlCg?e=aUgRWm"
# Función para descargar y leer la base de usuarios
get_user_base <- function() {
temp_file <- tempfile(fileext = ".xlsx")
GET(url = excel_url, write_disk(temp_file, overwrite = TRUE))
users <- tryCatch(read_xlsx(temp_file, sheet = "users"), error = function(e) NULL)
if (is.null(users)) {
# Si no hay usuarios, inicializar una base vacía
data.frame(
id = integer(),
user = character(),
password = c(digest::sodium::password_store("admin123"), digest::sodium::password_store("test123")),
excel_url <- "https://intaarg-my.sharepoint.com/:x:/g/personal/lewczuk_nuria_inta_gob_ar/EciVc8sF6BRHi6szY_uENk8BlSjNuxRN8Ikt4tVUpjRlCg?e=aUgRWm"
# Función para descargar y leer la base de usuarios
get_user_base <- function() {
temp_file <- tempfile(fileext = ".xlsx")
GET(url = excel_url, write_disk(temp_file, overwrite = TRUE))
users <- tryCatch(read_xlsx(temp_file, sheet = "users"), error = function(e) NULL)
if (is.null(users)) {
# Si no hay usuarios, inicializar una base vacía
data.frame(
id = integer(),
user = character(),
password = c(digest::sodium::password_store("admin123"), digest::sodium::password_store("test123")),
runApp()
#### Excel online ###
users <- get_user_base()
print(users)
runApp()
runApp()
runApp()
excel_url <- "https://intaarg-my.sharepoint.com/:x:/g/personal/lewczuk_nuria_inta_gob_ar/EciVc8sF6BRHi6szY_uENk8BlSjNuxRN8Ikt4tVUpjRlCg?e=aUgRWm"
# Función para descargar y leer la base de usuarios
get_user_base <- function() {
temp_file <- tempfile(fileext = ".xlsx")
GET(url = excel_url, write_disk(temp_file, overwrite = TRUE))
users <- tryCatch(read_xlsx(temp_file, sheet = "users"), error = function(e) NULL)
if (is.null(users)) {
# Si no hay usuarios, inicializar una base vacía
data.frame(
id = integer(),
user = character(),
password = character(),
name = character(),
email = character(),
registration_date = character(),
stringsAsFactors = FALSE
)
} else {
users
}
}
get_user_base <- reactive({
# Descarga y lee el archivo Excel
temp_file <- tempfile(fileext = ".xlsx")
httr::GET(url = excel_url, httr::write_disk(temp_file, overwrite = TRUE))
readxl::read_xlsx(temp_file, sheet = "users")
})
get_user_base
# Función para guardar usuarios en la base de datos
save_user_base <- function(data) {
temp_file <- tempfile(fileext = ".xlsx")
write.xlsx(data, temp_file, sheetName = "users", overwrite = TRUE)
PUT(url = excel_url, body = upload_file(temp_file))
}
# Función para agregar un nuevo usuario
save_new_user <- function(user, password, name, email) {
users <- get_user_base()
new_user <- data.frame(
id = if (nrow(users) > 0) max(users$id) + 1 else 1,
user = user,
password_hash = digest(password, algo = "sha256"),
name = name,
email = email,
registration_date = Sys.time(),
stringsAsFactors = FALSE
)
users <- rbind(users, new_user)
save_user_base(users)
}
save_new_user
users
excel_url
excel_url <- "https://intaarg-my.sharepoint.com/:x:/g/personal/lewczuk_nuria_inta_gob_ar/EciVc8sF6BRHi6szY_uENk8BlSjNuxRN8Ikt4tVUpjRlCg?e=aUgRWm"
# Función para descargar y leer la base de usuarios
get_user_base <- function() {
temp_file <- tempfile(fileext = ".xlsx")
GET(url = excel_url, write_disk(temp_file, overwrite = TRUE))
users <- tryCatch(read_xlsx(temp_file, sheet = "users"), error = function(e) NULL)
if (is.null(users)) {
# Si no hay usuarios, inicializar una base vacía
data.frame(
id = integer(),
user = character(),
password = character(),
name = character(),
email = character(),
registration_date = character(),
stringsAsFactors = FALSE
)
} else {
users
}
}
get_user_base <- reactive({
# Descarga y lee el archivo Excel
temp_file <- tempfile(fileext = ".xlsx")
httr::GET(url = excel_url, httr::write_disk(temp_file, overwrite = TRUE))
readxl::read_xlsx(temp_file, sheet = "users")
})
# Función para guardar usuarios en la base de datos
save_user_base <- function(data) {
temp_file <- tempfile(fileext = ".xlsx")
write.xlsx(data, temp_file, sheetName = "users", overwrite = TRUE)
PUT(url = excel_url, body = upload_file(temp_file))
}
# Función para agregar un nuevo usuario
save_new_user <- function(user, password, name, email) {
users <- get_user_base()
new_user <- data.frame(
id = if (nrow(users) > 0) max(users$id) + 1 else 1,
user = user,
password_hash = digest(password, algo = "sha256"),
name = name,
email = email,
registration_date = Sys.time(),
stringsAsFactors = FALSE
)
users <- rbind(users, new_user)
save_user_base(users)
}
users
#### Excel online ###
logout_init <- shinyauthr::logoutServer(
id = "logout",
active = reactive(credentials()$user_auth)
)
credentials <- shinyauthr::loginServer(
id = "login",
data = get_user_base(),
user_col = user,
pwd_col = password,
sodium_hashed = TRUE,
cookie_logins = TRUE,
sessionid_col = sessionid,
cookie_getter = get_sessionids_from_db,
cookie_setter = add_sessionid_to_db,
log_out = reactive(logout_init())
)
runApp()
runApp()
runApp()
library(rsconnect)
library(bslib)
library(shiny)
library(shinycssloaders)
library(bsicons)
library(flexdashboard)
library(DT)
library(tidyr)
library(ggplot2)
library(plotly)
library(dplyr)
library(bslib)
library(shinythemes)
library(shinyauthr)
library(htmlwidgets)
#library(RMySQL)
library(shinyjs)
library(bs4Dash)
library(fresh)
library(lubridate)
library(png)
library(httr)
library(readxl)
library(writexl)
library(openxlsx)
library(DBI)
library(RSQLite)
library(sodium)
library(kableExtra)
library(stringr)
library(purrr)
library(glue)
library(googlesheets4)
runApp()
runApp()
